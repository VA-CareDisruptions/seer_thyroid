---
title: "SEER Thyroid"
author: "Dan Weinberger"
date: '2023-07-17'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(lubridate)
library(MASS)
library(ggplot2)
library(patchwork) # combining plots

source('./R/RunControl.R')
source('./R/OutputsControl.R')

```

## Read in Data

```{r}
a1 <- read_excel('./CONFIDENTIAL/SEERThy.23.6.17SEND.xlsx', sheet='Rates x hist x mo', skip=2) %>%
  mutate( date = as.Date(paste(Year, Month, '01', sep='-'), '%Y-%B-%d')) %>%
  rename(monthdays = 'd/mo', Outcome=Count) %>%
  dplyr::select( Histology,date, Outcome, Population,monthdays ) %>%
    mutate(log_offset= log(Population/monthdays*30.3)) %>%
  arrange(Histology, date) 
```
The six panels in each figure will be: papillary cancers 2cm or less, papillary cancers >2cm, follicular, Oncocytic (formerly Hurthle cell), medullary and anaplastic.

## Panel A: Papillary {.tabset}
```{r}
b1 <- a1 %>%
  filter(Histology == 'Papillary') %>%
  arrange(date) %>%
  mutate(index=row_number())

set.start.date =as.Date('2020-03-01')

form1a <- ' ~ index + offset(log_offset)'
outcome <- 'Outcome_pre '
form1 <- paste0(outcome, form1a)

mod1 <- RunControl(ds=b1 ,set.start.date=set.start.date, set.form_cont1=form1)

out1 <-  OutputsControl(fitted.mod=mod1, niter=10000)
```

### RR trend
```{r}
out1$p.rr.trend
```
### Obs vs expected trend
```{r}
fig2a <- out1$p.preds
fig2a
```
### Cumukative prevented trend

```{r}
fig3a <- out1$p.cum_prevented
fig3a
```

## Panel C: Follicular {.tabset}
```{r}
b1 <- a1 %>%
  filter(Histology == 'Follicular') %>%
  arrange(date) %>%
  mutate(index=row_number())

set.start.date =as.Date('2020-03-01')

form1a <- ' ~ index + offset(log_offset)'
outcome <- 'Outcome_pre '
form1 <- paste0(outcome, form1a)

mod1 <- RunControl(ds=b1 ,set.start.date=set.start.date, set.form_cont1=form1)

out1 <-  OutputsControl(fitted.mod=mod1, niter=10000)
```

### RR trend
```{r}
out1$p.rr.trend
```
### Obs vs expected trend
```{r}
fig2c <- out1$p.preds
fig2c
```
### Cumulative prevented trend

```{r}
fig3c <- out1$p.cum_prevented
fig3c
```


## Panel D:  Oncocytic (formerly Hurthle cell) {.tabset}
```{r}
b1 <- a1 %>%
  filter(Histology == 'Hurthle') %>%
  arrange(date) %>%
  mutate(index=row_number())

set.start.date =as.Date('2020-03-01')

form1a <- ' ~ index + offset(log_offset)'
outcome <- 'Outcome_pre '
form1 <- paste0(outcome, form1a)

mod1 <- RunControl(ds=b1 ,set.start.date=set.start.date, set.form_cont1=form1)

out1 <-  OutputsControl(fitted.mod=mod1, niter=10000)
```

### RR trend
```{r}
out1$p.rr.trend
```
### Obs vs expected trend
```{r}
fig2d <- out1$p.preds
fig2d
```
### Cumulative prevented trend

```{r}
fig3d <- out1$p.cum_prevented
fig3d
```


## Panel E: Medullary {.tabset}
```{r}
b1 <- a1 %>%
  filter(Histology == 'Medullary') %>%
  arrange(date) %>%
  mutate(index=row_number())

set.start.date =as.Date('2020-03-01')

form1a <- ' ~ index + offset(log_offset)'
outcome <- 'Outcome_pre '
form1 <- paste0(outcome, form1a)

mod1 <- RunControl(ds=b1 ,set.start.date=set.start.date, set.form_cont1=form1)

out1 <-  OutputsControl(fitted.mod=mod1, niter=10000)
```

### RR trend
```{r}
out1$p.rr.trend
```
### Obs vs expected trend
```{r}
fig2e <- out1$p.preds
fig2e
```
### Cumulative prevented trend

```{r}
fig3e <- out1$p.cum_prevented
fig3e
```

## Panel F: Anaplastic {.tabset}
```{r}
b1 <- a1 %>%
  filter(Histology == 'Anaplastic') %>%
  arrange(date) %>%
  mutate(index=row_number())

set.start.date =as.Date('2020-03-01')

form1a <- ' ~ index + offset(log_offset)'
outcome <- 'Outcome_pre '
form1 <- paste0(outcome, form1a)

mod1 <- RunControl(ds=b1 ,set.start.date=set.start.date, set.form_cont1=form1)

out1 <-  OutputsControl(fitted.mod=mod1, niter=10000)
```

### RR trend
```{r}
out1$p.rr.trend
```
### Obs vs expected trend
```{r}
fig2f <- out1$p.preds
fig2f
```
### Cumulative prevented trend

```{r}
fig3f <- out1$p.cum_prevented
fig3f
```


```{r, fig.width=7, fig.height=4}
(fig2a + plot_spacer() + fig2c)/ (fig2d + fig2e + fig2f) +
   plot_annotation(tag_levels = 'A')
```

